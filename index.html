<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minecraft æ•´åˆåŒ…ç®¡ç†å™¨</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #6366f1;
            --background: #f8fafc;
            --surface: #ffffff;
            --border: #e2e8f0;
        }

        body {
            font-family: 'Inter', -apple-system, system-ui, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            background: var(--background);
            line-height: 1.6;
        }

        .card {
            background: var(--surface);
            border-radius: 1rem;
            padding: 1.5rem;
            margin: 1.5rem 0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border);
        }

        .file-item {
            display: grid;
            grid-template-columns: 40px minmax(200px, 1fr) 2fr 120px;
            align-items: center;
            gap: 1.5rem;
            padding: 1rem;
            margin: 0.75rem 0;
            background: var(--background);
            border-radius: 0.75rem;
        }

        .file-icon {
            text-align: center;
            font-size: 1.2rem;
            color: #64748b;
        }

        .file-path {
            font-family: 'Fira Code', monospace;
            font-size: 0.95rem;
            color: #334155;
        }

        .file-url {
            color: var(--primary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: 0.9rem;
        }

        .action-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            font-size: 0.9rem;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s;
        }

        .action-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .status-bar {
            margin-top: 1rem;
            padding: 0.75rem;
            background: rgba(0,0,0,0.05);
            border-radius: 0.5rem;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
        }

        .progress {
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            margin-top: 0.5rem;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: var(--primary);
            transition: width 0.3s ease;
        }

        @media (max-width: 768px) {
            .file-item {
                grid-template-columns: 40px 1fr;
                grid-template-rows: auto auto auto;
            }
            
            .file-url {
                grid-column: 2;
            }
            
            .action-btn {
                grid-column: 2;
                justify-self: start;
            }
        }
    </style>
</head>
<body>
    <h1>ğŸ› ï¸ æ•´åˆåŒ…ç®¡ç†å™¨ <span id="version" style="font-size:0.8em;color:#64748b"></span></h1>
    <div id="loading" class="card">
        <div style="display: flex; align-items: center; gap: 1rem;">
            <i class="fas fa-spinner fa-spin"></i>
            <span>æ­£åœ¨åŠ è½½æ›´æ–°ä¿¡æ¯...</span>
        </div>
        <div class="progress">
            <div id="progress-bar" class="progress-bar" style="width:0%"></div>
        </div>
    </div>
    <div id="file-list"></div>
    <div id="status" class="status-bar" style="display:none">
        <span id="status-text">å‡†å¤‡å°±ç»ª</span>
        <span id="latency">å»¶è¿Ÿ: è®¡ç®—ä¸­...</span>
    </div>

    <script>
        // æ€§èƒ½ä¼˜åŒ–é…ç½®
        const CONFIG = {
            CACHE_KEY: 'mc_patch_optimized',
            CACHE_TTL: 300000,
            DATA_URL: 'https://raw.githubusercontent.com/cleanper/UpdatePath/main/patch.json',
            ICON_MAP: {
                default: 'fa-file',
                delete: 'fa-trash',
                download: 'fa-download',
                replace: 'fa-exchange-alt',
                jar: 'fa-box-archive',
                zip: 'fa-file-zipper',
                yml: 'fa-file-code',
                cfg: 'fa-gear'
            },
            PROGRESS_INTERVAL: 100 // è¿›åº¦æ¡æ›´æ–°é—´éš”(ms)
        };

        class OptimizedPatchManager {
            static async init() {
                this.startTime = performance.now();
                this.updateProgress(10);
                
                try {
                    // å¹¶è¡Œåˆå§‹åŒ–UIå’ŒåŠ è½½æ•°æ®
                    await Promise.all([
                        this.initUI(),
                        this.loadData()
                    ]);
                    
                    this.updateProgress(90);
                    this.finalizeRender();
                } catch (error) {
                    this.handleError(error);
                } finally {
                    this.updateProgress(100);
                    this.showStatus();
                }
            }

            static initUI() {
                // é¢„æ¸²æŸ“UIæ¡†æ¶
                this.fileList = document.getElementById('file-list');
                this.loading = document.getElementById('loading');
                this.status = document.getElementById('status');
                this.statusText = document.getElementById('status-text');
                this.latencyText = document.getElementById('latency');
                this.updateProgress(30);
            }

            static async loadData() {
                this.updateProgress(40);
                const data = await this.fetchWithCache();
                this.updateProgress(70);
                this.render(data);
            }

            static async fetchWithCache() {
                // å°è¯•è¯»å–ç¼“å­˜
                const cached = this.getCache();
                if (cached) {
                    this.statusText.textContent = "ä½¿ç”¨ç¼“å­˜æ•°æ®";
                    return cached;
                }

                // æµ‹é‡è¯·æ±‚å»¶è¿Ÿ
                const latencyStart = performance.now();
                const response = await fetch(CONFIG.DATA_URL + '?t=' + Date.now());
                const latency = performance.now() - latencyStart;
                this.recordLatency(latency);

                if (!response.ok) throw new Error(`ç½‘ç»œé”™è¯¯: ${response.status}`);
                
                const data = await response.json();
                this.setCache(data);
                this.statusText.textContent = "ä½¿ç”¨ç½‘ç»œæ•°æ®";
                return data;
            }

            static recordLatency(latency) {
                this.latency = latency;
                this.latencyText.textContent = `å»¶è¿Ÿ: ${latency.toFixed(0)}ms`;
            }

            static render(data) {
                if (data.version) {
                    document.getElementById('version').textContent = `v${data.version}`;
                }

                const fragment = document.createDocumentFragment();
                
                // ä½¿ç”¨requestAnimationFrameåˆ†å—æ¸²æŸ“
                const renderChunk = (items, type, start = 0) => {
                    const chunkSize = 10; // æ¯æ‰¹æ¸²æŸ“10ä¸ª
                    const end = Math.min(start + chunkSize, items.length);
                    
                    for (let i = start; i < end; i++) {
                        fragment.appendChild(this.createFileItem(items[i], type));
                    }
                    
                    if (end < items.length) {
                        requestAnimationFrame(() => renderChunk(items, type, end));
                    }
                };

                if (data.delete?.length) {
                    const section = this.createSection('ğŸ—‘ï¸ å¾…åˆ é™¤æ–‡ä»¶');
                    fragment.appendChild(section);
                    renderChunk(data.delete, 'delete');
                }

                if (data.download?.additions?.length) {
                    const version = data.download.version ? ` (v${data.download.version})` : '';
                    const section = this.createSection(`ğŸ“¥ ä¸‹è½½æ›´æ–° ${data.download.additions.length}ä¸ªæ–‡ä»¶${version}`);
                    fragment.appendChild(section);
                    renderChunk(data.download.additions, 'download');
                }

                if (data.replace?.length) {
                    const section = this.createSection('ğŸ”„ æ–‡ä»¶æ›¿æ¢');
                    fragment.appendChild(section);
                    renderChunk(data.replace, 'replace');
                }

                this.fileList.appendChild(fragment);
            }

            static createSection(title) {
                const section = document.createElement('div');
                section.className = 'card';
                section.innerHTML = `<h2 style="margin-top:0">${title}</h2>`;
                return section;
            }

            static createFileItem(item, type) {
                const element = document.createElement('div');
                element.className = 'file-item';
                
                // æ€§èƒ½ä¼˜åŒ–ï¼šä½¿ç”¨æ¨¡æ¿å­—ç¬¦ä¸²ä¸€æ¬¡æ€§ç”Ÿæˆ
                const { icon, path, url } = this.getItemMetadata(item, type);
                const button = this.createActionButton(item, type, url);
                
                element.innerHTML = `
                    <div class="file-icon"><i class="fas ${icon}"></i></div>
                    <div class="file-path">${path}</div>
                    <div class="file-url">${url ? new URL(url).hostname : 'ç³»ç»Ÿæ“ä½œ'}</div>
                    ${button}
                `;

                return element;
            }

            static getItemMetadata(item, type) {
                let fileExt = '', fileName = '', path = '', url = '';
                
                if (type === 'download') {
                    fileName = item.name || '';
                    fileExt = fileName.split('.').pop();
                    path = `mods/${fileName}`;
                    url = item.url;
                } else if (type === 'replace') {
                    fileName = item.oldName || '';
                    fileExt = fileName.split('.').pop();
                    const newFile = item.newUrl.split('/').pop();
                    path = `${fileName} â†’ ${newFile}`;
                    url = item.newUrl;
                } else {
                    fileName = item;
                    fileExt = fileName.split('.').pop();
                    path = `mods/${fileName}`;
                }

                // ç¡®å®šå›¾æ ‡
                let icon = CONFIG.ICON_MAP[type] || CONFIG.ICON_MAP.default;
                if (fileExt && CONFIG.ICON_MAP[fileExt]) icon = CONFIG.ICON_MAP[fileExt];
                if (item.icon) icon = item.icon;

                return { icon, path, url };
            }

            static createActionButton(item, type, url) {
                const colors = { delete: '#ef4444', download: '#3b82f6', replace: '#10b981' };
                const icons = { delete: 'fa-trash', download: 'fa-download', replace: 'fa-rotate' };
                const texts = { delete: 'åˆ é™¤', download: 'ä¸‹è½½', replace: 'æ›¿æ¢' };
                const color = item.color || colors[type];

                if (type === 'delete') {
                    return `<div class="action-btn" style="background:${color}">
                        <i class="fas ${icons[type]}"></i>${texts[type]}
                    </div>`;
                }
                
                return `<a href="${url}" target="_blank" class="action-btn" style="background:${color}">
                    <i class="fas ${icons[type]}"></i>${texts[type]}
                </a>`;
            }

            static finalizeRender() {
                this.loading.style.display = 'none';
                this.fileList.style.display = 'block';
            }

            static showStatus() {
                this.status.style.display = 'flex';
                const loadTime = performance.now() - this.startTime;
                this.statusText.textContent += ` | åŠ è½½è€—æ—¶: ${loadTime.toFixed(0)}ms`;
            }

            static updateProgress(percent) {
                document.getElementById('progress-bar').style.width = `${percent}%`;
            }

            static handleError(error) {
                console.error('åŠ è½½å¤±è´¥:', error);
                document.getElementById('loading').innerHTML = `
                    <div style="color:#dc2626">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>åŠ è½½å¤±è´¥:</strong> ${error.message}
                        <button onclick="location.reload()" 
                                style="margin-left:1rem;padding:0.5rem 1rem;background:#dc2626;color:white;border:none;border-radius:0.5rem">
                            é‡è¯•
                        </button>
                    </div>
                `;
            }

            static getCache() {
                try {
                    const cache = localStorage.getItem(CONFIG.CACHE_KEY);
                    if (!cache) return null;
                    
                    const { expires, data } = JSON.parse(cache);
                    return Date.now() < expires ? data : null;
                } catch {
                    return null;
                }
            }

            static setCache(data) {
                try {
                    localStorage.setItem(CONFIG.CACHE_KEY, JSON.stringify({
                        expires: Date.now() + CONFIG.CACHE_TTL,
                        data: data
                    }));
                } catch (error) {
                    console.warn('ç¼“å­˜å†™å…¥å¤±è´¥:', error);
                }
            }
        }

        // å¯åŠ¨ä¼˜åŒ–ç‰ˆç®¡ç†å™¨
        window.addEventListener('DOMContentLoaded', () => {
            OptimizedPatchManager.init();
            
            // è¿›åº¦æ¡åŠ¨ç”»
            let progress = 0;
            const progressInterval = setInterval(() => {
                const bar = document.getElementById('progress-bar');
                if (!bar) {
                    clearInterval(progressInterval);
                    return;
                }
                
                const current = parseInt(bar.style.width) || 0;
                if (current < 100) {
                    progress = Math.min(progress + 1, 100);
                    bar.style.width = `${progress}%`;
                }
            }, CONFIG.PROGRESS_INTERVAL);
        });
    </script>
</body>
</html>
