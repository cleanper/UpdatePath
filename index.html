<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minecraft Êï¥ÂêàÂåÖÁÆ°ÁêÜÂô®</title>
    <style>
        :root {
            --primary: #6366f1;
            --background: #f8fafc;
            --surface: #ffffff;
            --border: #e2e8f0;
        }

        body {
            font-family: 'Inter', -apple-system, system-ui, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 2rem;
            background: var(--background);
            line-height: 1.6;
        }

        .card {
            background: var(--surface);
            border-radius: 1rem;
            padding: 1.5rem;
            margin: 1rem 0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border);
        }

        .file-item {
            display: grid;
            grid-template-columns: minmax(200px, 1fr) 2fr 100px;
            align-items: center;
            gap: 1.5rem;
            padding: 1rem;
            margin: 0.5rem 0;
            background: var(--background);
            border-radius: 0.75rem;
        }

        .path-display {
            font-family: 'Fira Code', monospace;
            font-size: 0.9rem;
            color: #475569;
        }

        .url {
            color: var(--primary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .badge {
            padding: 0.35rem 0.8rem;
            border-radius: 6px;
            font-size: 0.85rem;
            text-align: center;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <h1>üõ†Ô∏è Êï¥ÂêàÂåÖÁÆ°ÁêÜÂô® <span id="version" class="badge" style="background: #6366f1; color: white"></span></h1>
    <div id="loading" class="card">Ê≠£Âú®Âä†ËΩΩÊõ¥Êñ∞‰ø°ÊÅØ...</div>
    <div id="file-list"></div>

    <script>
        // ÈÖçÁΩÆÁÆ°ÁêÜÂô®
        const CONFIG = {
            CACHE_KEY: 'mc_patch_v4',
            CACHE_TTL: 300000,
            REPO_PATH: 'https://raw.githubusercontent.com/cleanper/UpdatePath/main/patch.json',
            FALLBACK_DATA: {
                download: { 
                    version: '0.0.0',
                    additions: [], 
                    deletions: [] 
                },
                replace: []
            }
        };

        // Â¢ûÂº∫ÂûãÊï∞ÊçÆËé∑ÂèñÂô®
        class DataFetcher {
            static async fetch() {
                try {
                    const cached = this._getValidCache();
                    if (cached) return cached;

                    const response = await fetch(CONFIG.REPO_PATH + '?t=' + Date.now());
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    
                    const data = await this._parseSafeJSON(response);
                    this._setCache(data);
                    return data;
                } catch (error) {
                    console.warn('Fetch error:', error);
                    return this._getValidCache() || CONFIG.FALLBACK_DATA;
                }
            }

            static async _parseSafeJSON(response) {
                try {
                    const data = await response.json();
                    // ÁªìÊûÑÈ™åËØÅ
                    if (!data.download || !Array.isArray(data.replace)) {
                        throw new Error('Invalid JSON structure');
                    }
                    // Â≠óÊÆµÈ™åËØÅ
                    data.replace.forEach(item => {
                        if (!item.oldName || !item.newUrl) {
                            throw new Error('Missing required fields in replace items');
                        }
                    });
                    return data;
                } catch (error) {
                    throw new Error(`JSONËß£ÊûêÂ§±Ë¥•: ${error.message}`);
                }
            }

            static _getValidCache() {
                try {
                    const cache = localStorage.getItem(CONFIG.CACHE_KEY);
                    if (!cache) return null;
                    
                    const { expires, data } = JSON.parse(cache);
                    if (Date.now() < expires && data.download && data.replace) {
                        return data;
                    }
                } catch {}
                return null;
            }

            static _setCache(data) {
                try {
                    localStorage.setItem(CONFIG.CACHE_KEY, JSON.stringify({
                        expires: Date.now() + CONFIG.CACHE_TTL,
                        data: data
                    }));
                } catch (error) {
                    console.warn('Cache write failed:', error);
                }
            }
        }

        // ÂÅ•Â£ÆÊ∏≤ÊüìÂô®
        class Renderer {
            static init() {
                this.fileList = document.getElementById('file-list');
                this.loading = document.getElementById('loading');
            }

            static async render() {
                try {
                    const data = await DataFetcher.fetch();
                    this._clearLoading();
                    this._renderVersion(data);
                    this._renderSections(data);
                } catch (error) {
                    this._showError(error);
                }
            }

            static _renderVersion(data) {
                const version = data.download?.version || '0.0.0';
                document.getElementById('version').textContent = `v${version}`;
            }

            static _renderSections(data) {
                const fragment = document.createDocumentFragment();
                
                // Âà†Èô§ÂàóË°®
                if (data.download.deletions?.length) {
                    fragment.appendChild(this._buildSection(
                        'üóëÔ∏è ÂæÖÂà†Èô§Êñá‰ª∂',
                        data.download.deletions.map(file => 
                            this._buildFileItem(
                                `mods/${file}`,
                                '#',
                                'delete'
                            )
                        )
                    ));
                }

                // Êñ∞Â¢ûÊñá‰ª∂
                if (data.download.additions?.length) {
                    fragment.appendChild(this._buildSection(
                        `üì• ‰∏ãËΩΩÊõ¥Êñ∞ (${data.download.additions.length}‰∏™Êñá‰ª∂)`,
                        data.download.additions.map(file => 
                            this._buildFileItem(
                                `mods/${file.name}`,
                                file.url,
                                'download'
                            )
                        )
                    ));
                }

                // ÊõøÊç¢Êñá‰ª∂
                if (data.replace?.length) {
                    fragment.appendChild(this._buildSection(
                        'üîÑ Êñá‰ª∂ÊõøÊç¢',
                        data.replace.map(item => 
                            this._buildFileItem(
                                `${item.oldName} ‚Üí ${this._extractFilename(item.newUrl)}`,
                                item.newUrl,
                                'replace'
                            )
                        )
                    ));
                }

                this.fileList.appendChild(fragment);
            }

            static _buildSection(title, items) {
                const section = document.createElement('div');
                section.className = 'card';
                section.innerHTML = `
                    <h2 style="margin: 0 0 1rem 0">${title}</h2>
                    ${items.join('')}
                `;
                return section;
            }

            static _buildFileItem(pathText, url, type) {
                return `
                    <div class="file-item">
                        <div class="path-display">${this._sanitize(pathText)}</div>
                        <a href="${this._sanitize(url)}" target="_blank" class="url">${this._getHostname(url)}</a>
                        <div class="badge" style="${this._getBadgeStyle(type)}">
                            ${this._getActionText(type)}
                        </div>
                    </div>
                `;
            }

            static _extractFilename(url) {
                try {
                    return new URL(url).pathname.split('/').pop();
                } catch {
                    return 'Êú™Áü•Êñá‰ª∂';
                }
            }

            static _getHostname(url) {
                try {
                    return new URL(url).hostname;
                } catch {
                    return 'Êó†ÊïàÈìæÊé•';
                }
            }

            static _getBadgeStyle(type) {
                const colors = {
                    delete: 'background: #ef4444; color: white',
                    download: 'background: #3b82f6; color: white',
                    replace: 'background: #10b981; color: white'
                };
                return colors[type] || '';
            }

            static _getActionText(type) {
                return {
                    delete: 'Âà†Èô§',
                    download: '‰∏ãËΩΩ',
                    replace: 'ÊõøÊç¢'
                }[type] || '';
            }

            static _sanitize(text) {
                return text.toString()
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;');
            }

            static _clearLoading() {
                this.loading.remove();
            }

            static _showError(error) {
                this.fileList.innerHTML = `
                    <div class="card" style="background: #fee2e2; color: #dc2626">
                        <h3>‚ö†Ô∏è Âä†ËΩΩÂ§±Ë¥•</h3>
                        <p>${this._sanitize(error.message)}</p>
                        <button onclick="window.location.reload()" 
                            style="margin-top: 0.5rem;
                                   padding: 0.5rem 1rem;
                                   background: #dc2626;
                                   color: white;
                                   border: none;
                                   border-radius: 0.375rem;">
                            ÈáçËØï
                        </button>
                    </div>
                `;
            }
        }

        // ÂàùÂßãÂåñ
        window.addEventListener('DOMContentLoaded', () => {
            Renderer.init();
            Renderer.render();
        });
    </script>
</body>
</html>
