<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>整合包更新系统</title>
    <style>
        :root {
            --primary: #2c3e50;
            --error: #e74c3c;
            --success: #27ae60;
        }

        #debug-console {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 10px;
            font-family: monospace;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }
    </style>
</head>
<body>
    <div id="app">
        <h1>整合包更新 <span id="version">加载中...</span></h1>
        <div id="content"></div>
        <div id="status">正在初始化...</div>
    </div>

    <!-- 调试控制台 -->
    <div id="debug-console"></div>
    <button onclick="toggleDebug()" style="position:fixed;top:10px;right:10px;">调试</button>

    <script>
        // 增强版配置
        const CONFIG = {
            repo: 'cleanper/UpdatePath',
            file: 'patch.txt',
            debugMode: false,
            cacheStrategy: 'stale-while-revalidate'
        };

        // 调试系统
        const Debugger = {
            log(message) {
                if (!CONFIG.debugMode) return;
                const console = document.getElementById('debug-console');
                console.innerHTML += `[${new Date().toLocaleTimeString()}] ${message}<br>`;
                console.scrollTop = console.scrollHeight;
            },
            error(error) {
                this.log(`<span style="color:red">ERROR: ${error.message}</span>`);
            }
        };

        // 核心数据处理器
        class UpdateProcessor {
            constructor() {
                this.cache = null;
                this.latestData = null;
            }

            async init() {
                try {
                    Debugger.log('初始化开始');
                    await this._loadData();
                    this._render();
                    Debugger.log('初始化完成');
                } catch (error) {
                    Debugger.error(error);
                    this._showError(error);
                }
            }

            async _loadData() {
                Debugger.log('开始加载数据');
                const cacheKey = `patch-cache-${CONFIG.file}`;
                
                // 缓存优先策略
                if (localStorage.getItem(cacheKey)) {
                    Debugger.log('检测到缓存数据');
                    this.cache = JSON.parse(localStorage.getItem(cacheKey));
                    if (Date.now() - this.cache.timestamp < 300000) {
                        Debugger.log('使用有效缓存');
                        this.latestData = this.cache.data;
                    }
                }

                // 网络请求
                try {
                    const response = await fetch(
                        `https://api.github.com/repos/${CONFIG.repo}/contents/${CONFIG.file}`
                    );
                    Debugger.log(`网络请求状态: ${response.status}`);
                    
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    
                    const data = await response.json();
                    const content = atob(data.content);
                    this.latestData = this._parseContent(content);
                    
                    // 更新缓存
                    localStorage.setItem(cacheKey, JSON.stringify({
                        timestamp: Date.now(),
                        data: this.latestData
                    }));
                    Debugger.log('缓存更新完成');
                } catch (error) {
                    Debugger.error(error);
                    if (!this.latestData) throw error;
                }
            }

            _parseContent(raw) {
                Debugger.log('开始解析内容');
                const data = {
                    version: '未知版本',
                    deletions: [],
                    additions: [],
                    replaces: []
                };

                let currentSection = null;
                let lineNumber = 0;

                raw.split('\n').forEach(line => {
                    lineNumber++;
                    const trimmed = line.trim();
                    if (!trimmed || trimmed.startsWith('#')) return;

                    // 段落检测
                    if (trimmed.endsWith('：')) {
                        currentSection = trimmed.replace('：', '').trim().toLowerCase();
                        Debugger.log(`进入段落: ${currentSection}`);
                        return;
                    }

                    // 分隔线处理
                    if (trimmed.startsWith('-----')) {
                        Debugger.log(`检测到分隔线 (第${lineNumber}行)`);
                        return;
                    }

                    // 字段处理
                    const fields = trimmed.split('|').map(f => f.trim());
                    switch(currentSection) {
                        case '版本':
                            if (fields[0]) data.version = fields[0];
                            break;
                        case '删除文件':
                            if (fields[0]) data.deletions.push(fields[0]);
                            break;
                        case '下载文件':
                            if (fields.length >= 2) {
                                data.additions.push({
                                    name: fields[0],
                                    url: fields[1],
                                    icon: fields[2] || 'default-icon.png'
                                });
                            }
                            break;
                        case '替换文件':
                            if (fields.length >= 2) {
                                data.replaces.push({
                                    oldName: fields[0],
                                    newUrl: fields[1],
                                    icon: fields[2] || 'default-icon.png'
                                });
                            }
                            break;
                    }
                });

                Debugger.log('解析完成');
                return data;
            }

            _render() {
                Debugger.log('开始渲染');
                if (!this.latestData) {
                    throw new Error('没有可用数据');
                }

                let html = '';
                
                // 版本信息
                document.getElementById('version').textContent = this.latestData.version;

                // 删除列表
                if (this.latestData.deletions.length) {
                    html += `<div class="section">
                        <h3>待删除文件 (${this.latestData.deletions.length})</h3>
                        <ul>${this.latestData.deletions.map(f => `<li>${f}</li>`).join('')}</ul>
                    </div>`;
                }

                // 新增内容
                if (this.latestData.additions.length) {
                    html += `<div class="section">
                        <h3>新增内容 (${this.latestData.additions.length})</h3>
                        ${this.latestData.additions.map(item => `
                            <div class="file-item">
                                <img src="${item.icon}" onerror="this.src='default-icon.png'">
                                <a href="${item.url}" target="_blank">${item.name}</a>
                            </div>
                        `).join('')}
                    </div>`;
                }

                // 文件更新
                if (this.latestData.replaces.length) {
                    html += `<div class="section">
                        <h3>文件更新 (${this.latestData.replaces.length})</h3>
                        ${this.latestData.replaces.map(item => `
                            <div class="file-item">
                                <div>${item.oldName}</div>
                                <a href="${item.newUrl}" target="_blank">更新</a>
                            </div>
                        `).join('')}
                    </div>`;
                }

                document.getElementById('content').innerHTML = html;
                document.getElementById('status').textContent = '就绪';
                Debugger.log('渲染完成');
            }

            _showError(error) {
                document.getElementById('status').innerHTML = `
                    <div style="color:var(--error)">
                        错误: ${error.message}<br>
                        <button onclick="window.location.reload()">重试</button>
                    </div>
                `;
            }
        }

        // 初始化系统
        const processor = new UpdateProcessor();
        processor.init();

        // 调试开关
        function toggleDebug() {
            CONFIG.debugMode = !CONFIG.debugMode;
            document.getElementById('debug-console').style.display = 
                CONFIG.debugMode ? 'block' : 'none';
        }
    </script>
</body>
</html>
