<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>æˆ‘çš„ä¸–ç•Œæ•´åˆåŒ…æ›´æ–°ç³»ç»Ÿ</title>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --background: #f8f9fa;
            --surface: #ffffff;
            --error: #e74c3c;
            --success: #27ae60;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            line-height: 1.5;
            background: var(--background);
            padding: 1rem;
            min-height: 100vh;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin: 2rem 0;
        }

        .card {
            background: var(--surface);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 3px 6px rgba(0,0,0,0.05);
        }

        .file-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .file-card {
            padding: 1rem;
            border: 1px solid #eee;
            border-radius: 8px;
            transition: transform 0.2s;
        }

        .file-card:hover {
            transform: translateY(-2px);
        }

        .file-icon {
            width: 48px;
            height: 48px;
            object-fit: contain;
            margin-bottom: 0.5rem;
        }

        .file-meta {
            margin-top: 0.5rem;
            font-size: 0.9em;
            color: #666;
        }

        #latency {
            position: fixed;
            left: 1rem;
            bottom: 1rem;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85em;
            backdrop-filter: blur(5px);
        }

        .skeleton {
            animation: skeleton-loading 1s linear infinite alternate;
            border-radius: 4px;
        }

        @keyframes skeleton-loading {
            0% { background-color: #f0f0f0; }
            100% { background-color: #e0e0e0; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>æ•´åˆåŒ…æ›´æ–°ç³»ç»Ÿ <span id="version"></span></h1>
        </header>
        
        <div id="content">
            <!-- éª¨æ¶å±åŠ è½½æ•ˆæœ -->
            <div class="card">
                <div class="skeleton" style="width: 200px; height: 28px; margin-bottom: 1rem;"></div>
                <div class="file-grid">
                    <div class="file-card skeleton" style="height: 120px;"></div>
                    <div class="file-card skeleton" style="height: 120px;"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="latency">æ­£åœ¨è¿æ¥æœåŠ¡å™¨...</div>

    <script>
        // é…ç½®ä¸­å¿ƒ
        const CONFIG = {
            repo: {
                owner: 'cleanper',
                name: 'UpdatePath',
                branch: 'main',
                file: 'patch.txt'
            },
            defaults: {
                icon: 'https://cdn-icons-png.flaticon.com/512/732/732238.png',
                cacheTTL: 300000 // 5åˆ†é’Ÿ
            }
        };

        // æ ¸å¿ƒæ§åˆ¶å™¨
        const UpdateManager = {
            async init() {
                try {
                    const startTime = performance.now();
                    const rawData = await this.fetchWithCache();
                    const parsedData = this.parseData(rawData);
                    this.render(parsedData);
                    this.updateLatency(startTime);
                } catch (error) {
                    this.handleError(error);
                }
            },

            // å¸¦ç¼“å­˜çš„ç½‘ç»œè¯·æ±‚
            async fetchWithCache() {
                const cached = this.getCache();
                if (cached) return cached;

                try {
                    const response = await fetch(
                        `https://api.github.com/repos/${CONFIG.repo.owner}/${CONFIG.repo.name}/contents/${CONFIG.repo.file}?ref=${CONFIG.repo.branch}`
                    );

                    if (!response.ok) throw new Error(`HTTPé”™è¯¯ ${response.status}`);
                    
                    const data = await response.json();
                    const content = atob(data.content);
                    this.setCache(content);
                    return content;
                } catch (error) {
                    if (cached) return cached;
                    throw error;
                }
            },

            // æ™ºèƒ½æ•°æ®è§£æ
            parseData(raw) {
                const data = {
                    version: 'æœ€æ–°ç‰ˆæœ¬',
                    deletions: [],
                    additions: [],
                    replaces: []
                };

                let currentSection = null;
                let lineNumber = 0;

                for (const line of raw.split('\n')) {
                    lineNumber++;
                    const trimmed = line.trim();
                    
                    // è·³è¿‡æ³¨é‡Šå’Œç©ºè¡Œ
                    if (!trimmed || trimmed.startsWith('#')) continue;

                    // æ®µè½æ£€æµ‹
                    if (trimmed.endsWith('ï¼š')) {
                        currentSection = trimmed.replace('ï¼š', '').trim();
                        continue;
                    }

                    // å­—æ®µå¤„ç†
                    const fields = trimmed.split('|').map(f => f.trim()).filter(f => f);
                    switch(currentSection) {
                        case 'ç‰ˆæœ¬':
                            data.version = fields[0] || data.version;
                            break;
                        case 'åˆ é™¤æ–‡ä»¶':
                            fields.length && data.deletions.push(fields[0]);
                            break;
                        case 'ä¸‹è½½æ–‡ä»¶':
                            if (fields.length >= 2) {
                                data.additions.push({
                                    name: fields[0],
                                    url: fields[1],
                                    icon: fields[2] || CONFIG.defaults.icon
                                });
                            }
                            break;
                        case 'æ›¿æ¢æ–‡ä»¶':
                            if (fields.length >= 2) {
                                data.replaces.push({
                                    oldName: fields[0],
                                    newUrl: fields[1],
                                    icon: fields[2] || CONFIG.defaults.icon
                                });
                            }
                            break;
                    }
                }

                return data;
            },

            // é«˜æ•ˆæ¸²æŸ“å¼•æ“
            render(data) {
                const fragment = document.createDocumentFragment();
                
                // ç‰ˆæœ¬æ˜¾ç¤º
                document.getElementById('version').textContent = data.version;

                // åˆ é™¤åˆ—è¡¨
                if (data.deletions.length) {
                    fragment.appendChild(this.buildSection(
                        'ğŸ—‘ï¸ å¾…åˆ é™¤æ–‡ä»¶',
                        data.deletions.map(item => `
                            <div class="file-card">
                                <div class="file-meta">${item}</div>
                                <div class="file-meta text-error">å³å°†åˆ é™¤</div>
                            </div>
                        `)
                    ));
                }

                // æ–°å¢æ–‡ä»¶
                if (data.additions.length) {
                    fragment.appendChild(this.buildSection(
                        'ğŸ“¥ æ–°å¢å†…å®¹',
                        data.additions.map(item => `
                            <div class="file-card">
                                <img src="${item.icon}" 
                                     class="file-icon" 
                                     alt="å›¾æ ‡"
                                     loading="lazy"
                                     onerror="this.src='${CONFIG.defaults.icon}'">
                                <div class="file-meta">
                                    <a href="${item.url}" 
                                       target="_blank" 
                                       rel="noopener">${item.name}</a>
                                </div>
                                <div class="file-meta">${new URL(item.url).hostname}</div>
                            </div>
                        `)
                    ));
                }

                // æ›¿æ¢æ–‡ä»¶
                if (data.replaces.length) {
                    fragment.appendChild(this.buildSection(
                        'ğŸ”„ æ–‡ä»¶æ›´æ–°',
                        data.replaces.map(item => `
                            <div class="file-card">
                                <img src="${item.icon}" 
                                     class="file-icon" 
                                     alt="å›¾æ ‡"
                                     loading="lazy"
                                     onerror="this.src='${CONFIG.defaults.icon}'">
                                <div class="file-meta">
                                    <div>${item.oldName}</div>
                                    <a href="${item.newUrl}" 
                                       target="_blank" 
                                       rel="noopener">æ–°ç‰ˆä¸‹è½½</a>
                                </div>
                            </div>
                        `)
                    ));
                }

                // ç©ºçŠ¶æ€å¤„ç†
                if (!fragment.children.length) {
                    fragment.appendChild(this.buildSection(
                        'ğŸ‰ å½“å‰æ²¡æœ‰å¾…æ›´æ–°å†…å®¹',
                        ['<div class="file-meta">æ‚¨çš„ç‰ˆæœ¬å·²ç»æ˜¯æœ€æ–°çš„äº†ï¼</div>']
                    ));
                }

                document.getElementById('content').replaceChildren(fragment);
            },

            // è¾…åŠ©æ–¹æ³•
            buildSection(title, items) {
                const section = document.createElement('div');
                section.className = 'card';
                section.innerHTML = `
                    <h2>${title}</h2>
                    <div class="file-grid">${items.join('')}</div>
                `;
                return section;
            },

            // ç¼“å­˜ç®¡ç†
            getCache() {
                try {
                    const cached = localStorage.getItem('patchData');
                    if (!cached) return null;
                    
                    const { time, data } = JSON.parse(cached);
                    return (Date.now() - time < CONFIG.defaults.cacheTTL) ? data : null;
                } catch {
                    return null;
                }
            },

            setCache(data) {
                localStorage.setItem('patchData', 
                    JSON.stringify({
                        time: Date.now(),
                        data: data
                    })
                );
            },

            // æ€§èƒ½ç›‘æ§
            updateLatency(startTime) {
                const latency = performance.now() - startTime;
                document.getElementById('latency').innerHTML = `
                    <span>å»¶è¿Ÿ: ${latency.toFixed(0)}ms</span>
                    <span style="margin:0 8px">â€¢</span>
                    <span>æ›´æ–°æ—¶é—´: ${new Date().toLocaleTimeString()}</span>
                `;
            },

            // é”™è¯¯å¤„ç†
            handleError(error) {
                console.error('ç³»ç»Ÿé”™è¯¯:', error);
                document.getElementById('latency').style.backgroundColor = var(--error);
                document.getElementById('latency').textContent = 'è¿æ¥æœåŠ¡å™¨å¤±è´¥';
                document.getElementById('content').innerHTML = `
                    <div class="card">
                        <h2>âš ï¸ æ•°æ®åŠ è½½å¤±è´¥</h2>
                        <div class="file-grid">
                            <div class="file-card">
                                <div class="file-meta">é”™è¯¯ä¿¡æ¯ï¼š${error.message}</div>
                                <button onclick="location.reload()" 
                                        style="margin-top:1rem;
                                               padding:0.5rem 1rem;
                                               background:var(--secondary);
                                               color:white;
                                               border:none;
                                               border-radius:6px;">
                                    é‡æ–°åŠ è½½
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
        };

        // å¯åŠ¨ç³»ç»Ÿ
        window.addEventListener('DOMContentLoaded', () => UpdateManager.init());
    </script>
</body>
</html>
